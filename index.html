<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finding Your Element - Exercise Two</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UMD versions for direct browser use) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel standalone to compile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const { useState, useEffect, useMemo } = React;
        
        // Safe access to environment variables
        const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, auth, db;
        if (firebaseConfigStr) {
            try {
                const firebaseConfig = JSON.parse(firebaseConfigStr);
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (e) { console.error("Firebase init failed:", e); }
        }

        // --- Helper Components ---
        const PieChart = ({ data, size = 250 }) => {
            const total = data.reduce((sum, d) => sum + d.value, 0);
            if (total === 0) {
                return (
                    <div style={{ width: size, height: size }} className="rounded-full bg-slate-100 flex items-center justify-center text-slate-400 border-2 border-dashed border-slate-300">
                        No data yet
                    </div>
                );
            }
            let startAngle = 0;
            return (
                <svg width={size} height={size} viewBox="-1 -1 2 2" className="transform -rotate-90 drop-shadow-md">
                    {data.map((slice, i) => {
                        if (slice.value === 0) return null;
                        const percent = slice.value / total;
                        if (percent === 1) return <circle key={i} cx="0" cy="0" r="1" fill={slice.color} />;
                        const endAngle = startAngle + percent * Math.PI * 2;
                        const startX = Math.cos(startAngle);
                        const startY = Math.sin(startAngle);
                        const endX = Math.cos(endAngle);
                        const endY = Math.sin(endAngle);
                        const largeArcFlag = percent > 0.5 ? 1 : 0;
                        const pathData = [`M 0 0`, `L ${startX} ${startY}`, `A 1 1 0 ${largeArcFlag} 1 ${endX} ${endY}`, `Z`].join(' ');
                        startAngle = endAngle;
                        return (
                            <path key={i} d={pathData} fill={slice.color} className="transition-all duration-500 hover:opacity-80 cursor-pointer">
                                <title>{slice.label}: {slice.value} hrs ({Math.round(percent * 100)}%)</title>
                            </path>
                        );
                    })}
                </svg>
            );
        };

        const TrashIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>);
        const EditIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>);

        const DEFAULT_CATEGORIES = ["Paid Work", "Unpaid Work", "Recreation", "Socializing", "Hobbies", "Keeping Fit", "Chores", "Commuting", "Sleep"];
        const FEELINGS = {
          LIKE: { id: 'like', label: 'Like It', color: '#10b981', bgClass: 'bg-emerald-100', textClass: 'text-emerald-800', borderClass: 'border-emerald-300', icon: 'ðŸ˜Š' },
          NEUTRAL: { id: 'neutral', label: "Don't Mind It", color: '#f59e0b', bgClass: 'bg-yellow-100', textClass: 'text-yellow-800', borderClass: 'border-yellow-300', icon: 'ðŸ˜' },
          DISLIKE: { id: 'dislike', label: "Don't Like It", color: '#f43f5e', bgClass: 'bg-rose-100', textClass: 'text-rose-800', borderClass: 'border-rose-300', icon: 'ðŸ˜©' }
        };
        const DAYS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

        function App() {
          const [activities, setActivities] = useState([]);
          const [reflection, setReflection] = useState("");
          const [customCategory, setCustomCategory] = useState("");
          const [isClearing, setIsClearing] = useState(false);
          const [editingId, setEditingId] = useState(null);
          const [user, setUser] = useState(null);
          const [isLoaded, setIsLoaded] = useState(false);
          const [formData, setFormData] = useState({
            name: '', category: DEFAULT_CATEGORIES[0], inputMode: 'weekly', hours: '',
            schedule: { Mon: '', Tue: '', Wed: '', Thu: '', Fri: '', Sat: '', Sun: '' },
            feeling: FEELINGS.LIKE.id, isConcurrent: false, linkedActivityIds: []
          });

          // Authentication and Cloud Sync setup
          useEffect(() => {
            if (!db) {
                // Graceful fallback to LocalStorage if deployed outside the cloud environment
                const saved = localStorage.getItem('findingElementData');
                const savedReflection = localStorage.getItem('findingElementReflection');
                if (saved) setActivities(JSON.parse(saved));
                if (savedReflection) setReflection(savedReflection);
                setIsLoaded(true);
                return;
            }

            const initAuth = async () => {
              try {
                if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                else await signInAnonymously(auth);
              } catch(e) { console.error("Auth error:", e); }
            };
            initAuth();
            const unsubscribe = onAuthStateChanged(auth, setUser);
            return () => unsubscribe();
          }, []);

          // Realtime Cloud Data Loading
          useEffect(() => {
            if (!db || !user) return;
            const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'appState', 'main');
            
            const unsubscribe = onSnapshot(docRef, (docSnap) => {
              if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.activities) setActivities(data.activities);
                if (data.reflection !== undefined) setReflection(data.reflection);
              }
              setIsLoaded(true);
            }, (error) => {
              console.error("Firestore error:", error);
              setIsLoaded(true);
            });

            return () => unsubscribe();
          }, [user]);

          // Save Data Logic (Cloud or LocalStorage)
          const updateActivities = (newActivities) => {
            setActivities(newActivities);
            if (db && user) {
              setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'appState', 'main'), { activities: newActivities }, { merge: true });
            } else if (!db) {
              localStorage.setItem('findingElementData', JSON.stringify(newActivities));
            }
          };

          // Save Reflection Logic
          useEffect(() => {
            if (!isLoaded) return;
            if (db && user) {
                const timer = setTimeout(() => {
                  setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'appState', 'main'), { reflection: reflection }, { merge: true });
                }, 1000);
                return () => clearTimeout(timer);
            } else if (!db) {
                localStorage.setItem('findingElementReflection', reflection);
            }
          }, [reflection, user, isLoaded]);

          const loadSampleData = () => {
            const sampleData = [
              { id: '1', name: 'Meetings', category: 'Paid Work', hours: 10, feeling: 'dislike', inputMode: 'weekly', isConcurrent: false, linkedActivityIds: [] },
              { id: '2', name: 'Deep Work', category: 'Paid Work', hours: 25, feeling: 'like', inputMode: 'weekly', isConcurrent: false, linkedActivityIds: [] },
              { id: '4', name: 'Commuting', category: 'Commuting', hours: 7.5, feeling: 'dislike', inputMode: 'daily', schedule: { Mon: '1.5', Tue: '1.5', Wed: '1.5', Thu: '1.5', Fri: '1.5', Sat: '', Sun: '' }, isConcurrent: false, linkedActivityIds: [] },
              { id: '7', name: 'Cooking', category: 'Chores', hours: 7, feeling: 'neutral', inputMode: 'daily', schedule: { Mon: '1', Tue: '1', Wed: '1', Thu: '1', Fri: '1', Sat: '1', Sun: '1' }, isConcurrent: false, linkedActivityIds: [] },
              { id: '10', name: 'Sleep', category: 'Sleep', hours: 46, feeling: 'like', inputMode: 'daily', schedule: { Mon: '6', Tue: '6', Wed: '6', Thu: '6', Fri: '8', Sat: '8', Sun: '6' }, isConcurrent: false, linkedActivityIds: [] },
              { id: '11', name: 'Watching OTT', category: 'Hobbies', hours: 10.5, feeling: 'like', inputMode: 'weekly', isConcurrent: true, linkedActivityIds: ['4', '7'] },
            ];
            updateActivities(sampleData);
          };

          const handleSubmit = (e) => {
            e.preventDefault();
            if (!formData.name) return;
            
            let calculatedHours = 0;
            if (formData.inputMode === 'weekly') {
              if (!formData.hours) return;
              calculatedHours = parseFloat(formData.hours);
            } else {
              calculatedHours = Object.values(formData.schedule).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
              if (calculatedHours === 0) return;
            }

            const categoryToUse = customCategory.trim() ? customCategory.trim() : formData.category;
            const activityData = {
              name: formData.name.trim(), category: categoryToUse, hours: calculatedHours, feeling: formData.feeling,
              inputMode: formData.inputMode, schedule: formData.schedule, isConcurrent: formData.isConcurrent,
              linkedActivityIds: formData.isConcurrent ? formData.linkedActivityIds : []
            };

            if (editingId) {
              updateActivities(activities.map(a => a.id === editingId ? { ...a, ...activityData } : a));
              setEditingId(null);
            } else {
              updateActivities([...activities, { id: crypto.randomUUID(), ...activityData }]);
            }
            
            setFormData({ name: '', category: DEFAULT_CATEGORIES[0], inputMode: formData.inputMode, hours: '', schedule: { Mon: '', Tue: '', Wed: '', Thu: '', Fri: '', Sat: '', Sun: '' }, feeling: FEELINGS.LIKE.id, isConcurrent: false, linkedActivityIds: [] });
            setCustomCategory("");
          };

          const handleEditActivity = (activity) => {
            setEditingId(activity.id);
            setFormData({
              name: activity.name, category: activity.category, inputMode: activity.inputMode || (activity.isDaily ? 'daily' : 'weekly'),
              hours: activity.hours || '', schedule: activity.schedule || { Mon: '', Tue: '', Wed: '', Thu: '', Fri: '', Sat: '', Sun: '' },
              feeling: activity.feeling, isConcurrent: activity.isConcurrent || false, linkedActivityIds: activity.linkedActivityIds || []
            });
            setCustomCategory("");
            window.scrollTo({ top: 0, behavior: 'smooth' });
          };

          const cancelEdit = () => {
            setEditingId(null);
            setFormData({ name: '', category: DEFAULT_CATEGORIES[0], inputMode: formData.inputMode, hours: '', schedule: { Mon: '', Tue: '', Wed: '', Thu: '', Fri: '', Sat: '', Sun: '' }, feeling: FEELINGS.LIKE.id, isConcurrent: false, linkedActivityIds: [] });
            setCustomCategory("");
          };

          const deleteActivity = (id) => updateActivities(activities.filter(a => a.id !== id));

          const physicalHoursLogged = activities.filter(a => !a.isConcurrent).reduce((sum, a) => sum + a.hours, 0);
          const totalActivityHours = activities.reduce((sum, a) => sum + a.hours, 0);

          const categoriesData = useMemo(() => {
            const grouped = activities.reduce((acc, activity) => {
              if (!acc[activity.category]) acc[activity.category] = { name: activity.category, totalHours: 0, items: [] };
              acc[activity.category].totalHours += activity.hours;
              acc[activity.category].items.push(activity);
              return acc;
            }, {});

            const arr = Object.values(grouped).sort((a, b) => b.totalHours - a.totalHours);
            const maxHours = Math.max(...arr.map(c => c.totalHours), 1);
            
            return arr.map(cat => ({
              ...cat, circleSize: Math.max(80, Math.sqrt(cat.totalHours / maxHours) * 180) 
            }));
          }, [activities]);

          const feelingsChartData = useMemo(() => {
            const sums = { [FEELINGS.LIKE.id]: 0, [FEELINGS.NEUTRAL.id]: 0, [FEELINGS.DISLIKE.id]: 0 };
            activities.forEach(a => { sums[a.feeling] += a.hours; });
            return [
              { label: FEELINGS.LIKE.label, value: sums[FEELINGS.LIKE.id], color: FEELINGS.LIKE.color, dataKey: FEELINGS.LIKE.id },
              { label: FEELINGS.NEUTRAL.label, value: sums[FEELINGS.NEUTRAL.id], color: FEELINGS.NEUTRAL.color, dataKey: FEELINGS.NEUTRAL.id },
              { label: FEELINGS.DISLIKE.label, value: sums[FEELINGS.DISLIKE.id], color: FEELINGS.DISLIKE.color, dataKey: FEELINGS.DISLIKE.id },
            ];
          }, [activities]);

          const uniqueCategories = Array.from(new Set([...DEFAULT_CATEGORIES, ...activities.map(a => a.category)]));

          return (
            <div className="min-h-screen bg-slate-50 text-slate-800 p-4 md:p-8 font-sans">
              <div className="max-w-6xl mx-auto space-y-8">
                
                <header className="bg-white p-8 rounded-2xl shadow-sm border border-slate-100 text-center">
                  <h1 className="text-3xl md:text-4xl font-bold text-slate-900 mb-4">Finding Your Element</h1>
                  <h2 className="text-xl text-slate-600 font-medium mb-6">Exercise Two: What Are You Doing?</h2>
                  <p className="max-w-3xl mx-auto text-slate-600 leading-relaxed mb-6 text-left md:text-center">
                    The aim of this exercise is to help you take stock of where you are now in your life and what you feel about it. 
                    List everything you do in a typical week, categorize them, and indicate how you feel about each activity.
                  </p>
                  <div className="flex justify-center gap-4">
                    <button onClick={loadSampleData} className="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm font-medium transition-colors">
                      Load Sample Data
                    </button>
                    {isClearing ? (
                      <div className="flex gap-2 items-center">
                        <span className="text-sm text-red-600 font-medium ml-2">Are you sure?</span>
                        <button onClick={() => { updateActivities([]); setReflection(''); setIsClearing(false); }} className="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium transition-colors">
                          Yes, Clear
                        </button>
                        <button onClick={() => setIsClearing(false)} className="px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm font-medium transition-colors">
                          Cancel
                        </button>
                      </div>
                    ) : (
                      <button onClick={() => setIsClearing(true)} className="px-4 py-2 bg-red-50 hover:bg-red-100 text-red-600 rounded-lg text-sm font-medium transition-colors">
                        Clear All
                      </button>
                    )}
                  </div>
                </header>

                <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                  <div className="lg:col-span-5 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
                      <span className="bg-blue-600 text-white w-6 h-6 rounded-full inline-flex items-center justify-center text-sm">1</span> 
                      Log Your Activities
                    </h3>
                    
                    <form onSubmit={handleSubmit} className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">Activity Keyword</label>
                        <input type="text" required placeholder="e.g., E-mails, Gardening, Gym..." className="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                      </div>

                      <div className="flex bg-slate-100 p-1 rounded-lg">
                        <button type="button" className={`flex-1 text-sm py-1.5 rounded-md transition-colors ${formData.inputMode === 'weekly' ? 'bg-white shadow-sm font-medium text-slate-800' : 'text-slate-500 hover:text-slate-700'}`} onClick={() => setFormData({...formData, inputMode: 'weekly'})}>
                          Weekly Total
                        </button>
                        <button type="button" className={`flex-1 text-sm py-1.5 rounded-md transition-colors ${formData.inputMode === 'daily' ? 'bg-white shadow-sm font-medium text-slate-800' : 'text-slate-500 hover:text-slate-700'}`} onClick={() => setFormData({...formData, inputMode: 'daily'})}>
                          Daily Routine
                        </button>
                      </div>

                      {formData.inputMode === 'weekly' ? (
                        <div>
                          <label className="block text-sm font-medium text-slate-700 mb-1">Total Hours / Week</label>
                          <input type="number" step="0.5" min="0" max="168" required={formData.inputMode === 'weekly'} placeholder="e.g., 5" className="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" value={formData.hours} onChange={e => setFormData({...formData, hours: e.target.value})} />
                        </div>
                      ) : (
                        <div>
                          <label className="block text-sm font-medium text-slate-700 mb-2">Hours per Day</label>
                          <div className="grid grid-cols-7 gap-1.5 sm:gap-2">
                            {DAYS.map(day => (
                              <div key={day} className="flex flex-col items-center">
                                <label className="text-[10px] sm:text-xs font-semibold text-slate-500 mb-1 uppercase tracking-wider">{day.charAt(0)}</label>
                                <input type="number" step="0.5" min="0" max="24" placeholder="0" className="w-full px-1 sm:px-2 py-2 text-center text-sm rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" value={formData.schedule[day]} onChange={e => setFormData({...formData, schedule: {...formData.schedule, [day]: e.target.value}})} />
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">Category</label>
                        <select className="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" value={formData.category} onChange={e => { setFormData({...formData, category: e.target.value}); if (e.target.value !== 'custom') setCustomCategory(''); }}>
                          {uniqueCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                          <option value="custom">+ Add Custom...</option>
                        </select>
                      </div>

                      {formData.category === 'custom' && (
                        <div>
                          <label className="block text-sm font-medium text-slate-700 mb-1">Custom Category Name</label>
                          <input type="text" required placeholder="Enter custom category" className="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" value={customCategory} onChange={e => setCustomCategory(e.target.value)} />
                        </div>
                      )}

                      <div>
                        <label className="block text-sm font-medium text-slate-700 mb-2">How do you feel about it?</label>
                        <div className="grid grid-cols-3 gap-2">
                          {Object.values(FEELINGS).map((feeling) => (
                            <button key={feeling.id} type="button" onClick={() => setFormData({...formData, feeling: feeling.id})} className={`p-2 rounded-lg border text-sm font-medium flex flex-col items-center gap-1 transition-all ${ formData.feeling === feeling.id ? `${feeling.bgClass} ${feeling.textClass} border-${feeling.color.replace('#', '')} ring-2 ring-offset-1 ring-${feeling.color.replace('#', '')}` : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50' }`} style={{ borderColor: formData.feeling === feeling.id ? feeling.color : undefined }}>
                              <span className="text-xl">{feeling.icon}</span>
                              <span className="text-xs text-center">{feeling.label}</span>
                            </button>
                          ))}
                        </div>
                      </div>

                      <div className="flex items-start gap-2 pt-2">
                        <input type="checkbox" id="isConcurrent" className="mt-1 w-4 h-4 text-blue-600 rounded border-slate-300 focus:ring-blue-500 cursor-pointer" checked={formData.isConcurrent} onChange={e => setFormData({...formData, isConcurrent: e.target.checked})} />
                        <label htmlFor="isConcurrent" className="text-sm text-slate-700 cursor-pointer leading-tight">
                          <span className="font-medium block">Concurrent Activity</span>
                          <span className="text-xs text-slate-500">I do this at the same time as something else (won't count towards the base 168hr week limit)</span>
                        </label>
                      </div>

                      {formData.isConcurrent && (
                        <div className="bg-slate-50 border border-slate-200 rounded-xl p-3 mt-2">
                          <label className="block text-xs font-medium text-slate-700 mb-2">Select activities this happens during:</label>
                          {activities.filter(a => a.id !== editingId && !a.isConcurrent).length === 0 ? (
                            <p className="text-xs text-slate-400 italic">No base activities logged yet. Add your main activities first!</p>
                          ) : (
                            <div className="flex flex-wrap gap-1.5">
                              {activities.filter(a => a.id !== editingId && !a.isConcurrent).map(a => {
                                const isLinked = formData.linkedActivityIds.includes(a.id);
                                return (
                                  <button key={a.id} type="button" onClick={() => { if (isLinked) { setFormData({...formData, linkedActivityIds: formData.linkedActivityIds.filter(id => id !== a.id)}); } else { setFormData({...formData, linkedActivityIds: [...formData.linkedActivityIds, a.id]}); } }} className={`px-2.5 py-1 text-xs font-medium rounded-full border transition-colors ${ isLinked ? 'bg-purple-100 border-purple-300 text-purple-700' : 'bg-white border-slate-200 text-slate-600 hover:border-slate-300' }`}>
                                    {isLinked && 'âœ“ '} {a.name}
                                  </button>
                                );
                              })}
                            </div>
                          )}
                        </div>
                      )}

                      <div className="flex gap-2 mt-2">
                        <button type="submit" className="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-sm transition-colors">
                          {editingId ? 'Save Changes' : 'Add Activity'}
                        </button>
                        {editingId && (
                          <button type="button" onClick={cancelEdit} className="py-3 px-4 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold rounded-lg shadow-sm transition-colors">Cancel</button>
                        )}
                      </div>
                    </form>
                  </div>

                  <div className="lg:col-span-7 bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col">
                     <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-bold">Activity Log</h3>
                        <span className="text-sm font-medium px-3 py-1 bg-slate-100 rounded-full text-slate-600" title="Concurrent activities are excluded from this base limit.">
                            Base: <span className={physicalHoursLogged > 168 ? "text-red-600 font-bold" : ""}>{physicalHoursLogged}</span> / 168 hrs
                        </span>
                     </div>
                    
                    {activities.length === 0 ? (
                      <div className="flex-1 flex flex-col items-center justify-center text-slate-400 border-2 border-dashed border-slate-200 rounded-xl p-8">
                        <p>No activities added yet.</p>
                        <p className="text-sm">Start by adding your typical weekly activities on the left.</p>
                      </div>
                    ) : (
                      <div className="flex-1 overflow-y-auto max-h-[400px] pr-2 space-y-2">
                        {activities.slice().reverse().map(activity => {
                          const feeling = Object.values(FEELINGS).find(f => f.id === activity.feeling);
                          const linkedNames = activity.linkedActivityIds ? activity.linkedActivityIds.map(id => activities.find(a => a.id === id)?.name).filter(Boolean) : [];
                          const scheduleSummary = activity.schedule ? Object.entries(activity.schedule).filter(([_, h]) => h && parseFloat(h) > 0).map(([day, h]) => `${day.substring(0,2)}:${h}h`).join(', ') : '';

                          return (
                            <div key={activity.id} className="flex items-center justify-between p-3 rounded-lg border border-slate-100 bg-slate-50 hover:bg-slate-100 transition-colors">
                              <div>
                                <div className="font-semibold text-slate-800 flex flex-wrap items-center gap-2">
                                  {activity.name}
                                  {activity.isConcurrent && (
                                    <span className="text-[10px] bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded tracking-wider font-bold mt-0.5">
                                      {linkedNames.length > 0 ? `DURING ${linkedNames.join(', ').toUpperCase()}` : 'CONCURRENT'}
                                    </span>
                                  )}
                                </div>
                                <div className="text-xs text-slate-500 mt-0.5">
                                  {activity.category} â€¢ 
                                  {activity.inputMode === 'daily' && scheduleSummary ? ` [${scheduleSummary}] = ` : ' '}
                                  {activity.hours} hrs
                                </div>
                              </div>
                              <div className="flex items-center gap-3 ml-4">
                                <span className={`px-2 py-1 rounded text-xs font-medium ${feeling.bgClass} ${feeling.textClass} shrink-0`}>
                                  {feeling.icon} {feeling.label}
                                </span>
                                <button onClick={() => handleEditActivity(activity)} className="text-slate-400 hover:text-blue-500 transition-colors p-1" title="Edit"><EditIcon /></button>
                                <button onClick={() => deleteActivity(activity.id)} className="text-slate-400 hover:text-red-500 transition-colors p-1" title="Delete"><TrashIcon /></button>
                              </div>
                            </div>
                          )
                        })}
                      </div>
                    )}
                  </div>
                </div>

                <div className="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-slate-100">
                    <h3 className="text-2xl font-bold mb-2 flex items-center gap-2">
                      <span className="bg-blue-600 text-white w-8 h-8 rounded-full inline-flex items-center justify-center text-lg">2</span> 
                      Category Circles
                    </h3>
                    
                    {categoriesData.length === 0 ? (
                      <div className="text-center py-12 text-slate-400 italic">Circles will appear here once you log activities.</div>
                    ) : (
                      <div className="flex flex-wrap justify-center gap-8 items-end mt-8">
                        {categoriesData.map((cat, idx) => (
                          <div key={idx} className="flex flex-col items-center gap-4">
                            <div className="bg-blue-50 rounded-full border-4 border-blue-100 flex items-center justify-center relative shadow-inner overflow-hidden" style={{ width: `${cat.circleSize}px`, height: `${cat.circleSize}px` }}>
                              <div className="absolute inset-0 flex flex-col items-center justify-center text-center p-2">
                                <span className="font-bold text-blue-900 text-sm md:text-base leading-tight drop-shadow-sm">{cat.name}</span>
                                <span className="text-xs md:text-sm font-medium text-blue-700">{cat.totalHours} hrs</span>
                              </div>
                            </div>
                            <div className="flex flex-wrap justify-center gap-1.5 max-w-[200px]">
                              {cat.items.map(item => {
                                const feeling = Object.values(FEELINGS).find(f => f.id === item.feeling);
                                return (
                                  <span key={item.id} className={`text-[11px] px-2 py-0.5 rounded-full border shadow-sm ${feeling.bgClass} ${feeling.textClass} ${feeling.borderClass}`} title={`${item.name}: ${item.hours}h`}>
                                    {item.name}
                                  </span>
                                )
                              })}
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                  <div className="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center text-center">
                    <h3 className="text-2xl font-bold mb-6 flex items-center justify-center gap-2 w-full">
                      <span className="bg-blue-600 text-white w-8 h-8 rounded-full inline-flex items-center justify-center text-lg">3</span> 
                      The Big Picture
                    </h3>
                    <div className="flex-1 flex items-center justify-center w-full py-4">
                      <PieChart data={feelingsChartData} size={220} />
                    </div>
                    <div className="w-full space-y-3 mt-6">
                      {feelingsChartData.map(d => {
                        const percent = totalActivityHours > 0 ? Math.round((d.value / totalActivityHours) * 100) : 0;
                        return (
                          <div key={d.label} className="flex items-center justify-between text-sm">
                            <div className="flex items-center gap-2">
                              <div className="w-3 h-3 rounded-full" style={{ backgroundColor: d.color }}></div>
                              <span className="font-medium text-slate-700">{d.label}</span>
                            </div>
                            <div className="text-slate-600 font-semibold">{d.value} hrs <span className="text-slate-400 font-normal">({percent}%)</span></div>
                          </div>
                        )
                      })}
                    </div>
                  </div>

                  <div className="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-slate-100 flex flex-col">
                    <h3 className="text-2xl font-bold mb-4 flex items-center gap-2">
                      <span className="bg-blue-600 text-white w-8 h-8 rounded-full inline-flex items-center justify-center text-lg">4</span> 
                      Reflection
                    </h3>
                    <p className="text-slate-600 mb-4 text-sm font-medium">
                      Spend a little time reflecting on the pattern of your life that this exercise has shown. What do you feel about it? What flexibility do you see here? What would you like to change?
                    </p>
                    <textarea className="flex-1 w-full min-h-[250px] p-4 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all resize-none text-slate-700" placeholder="Type your reflections here..." value={reflection} onChange={(e) => setReflection(e.target.value)}></textarea>
                  </div>
                </div>

              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
